From d966484c2c75174174d2adb1274b3bee70487598 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Palancher?= <remi-externe.palancher@edf.fr>
Date: Tue, 12 Apr 2022 15:35:33 +0200
Subject: [PATCH 4/4] exec-cuda.sh script

---
 contrib/exec-cuda.sh | 32 ++++++++++++++++++++++++++++++++
 1 file changed, 32 insertions(+)
 create mode 100644 contrib/exec-cuda.sh

diff --git a/contrib/exec-cuda.sh b/contrib/exec-cuda.sh
new file mode 100644
index 0000000..f96cdac
--- /dev/null
+++ b/contrib/exec-cuda.sh
@@ -0,0 +1,32 @@
+#!/bin/bash
+
+# This script is a collectd plugin that gathers metrics
+# from Nvidia cards.
+
+declare -A config=(
+#	["temperature_gpu"]=temperature
+#	["fan_speed"]=percent
+#	["pstate"]=absolute
+#	["memory_used"]=memory
+#	["memory_free"]=memory
+	["utilization_gpu"]=percent
+	["utilization_memory"]=percent
+#	["power_draw"]=power
+)
+
+HOSTNAME="${COLLECTD_HOSTNAME:-$(hostname --fqdn)}"
+INTERVAL="${COLLECTD_INTERVAL:-10}"
+
+for parameter in "${!config[@]}"
+do
+	query_string="${parameter//_/.},"
+	gpus_state=$(nvidia-smi --query-gpu="${query_string}" --format=csv,noheader,nounits)
+
+	i=0
+	while read line
+	do
+		i=$((i+$line))
+	done <<< "${gpus_state// }"
+
+	echo "PUTVAL ${HOSTNAME}/cuda/${config[$parameter]}-${parameter} interval=$INTERVAL N:$i"
+done
-- 
2.20.1

